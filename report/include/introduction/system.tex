\begin{tikzpicture}[node distance=2cm,-latex]

\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}
\tikzstyle{sensor}=[node distance=1.5cm,draw, rectangle,fill=blue!20, text
width=2cm,text centered,minimum width=2cm, minimum height=1cm]
\tikzstyle{perc}=[draw, node distance=4cm,draw, rectangle,fill=green!20, text
width=2cm,text centered,minimum width=2cm, minimum height=1cm]
\tikzstyle{control}=[draw, node distance=3cm,draw, rectangle,fill=red!20,
text width=2.5cm,text centered,minimum width=.5cm, minimum height=3cm]

%% Sensors Nodes 
\node[sensor] (cam) {Camera};
\node[sensor,below of=cam] (vicon) {Motion capture};
\node[sensor,below of=vicon] (lidar) {Lidar};
\node[node distance=1cm,above= of cam.west,anchor=west] (sensors) {Sensors};

\begin{pgfonlayer}{background}
    \node[fit=(sensors) (cam) (vicon) (lidar), draw,fill=yellow!20] (frame) {}; 
\end{pgfonlayer}

%% Perception Nodes
\node[perc,node distance=4cm,right of=cam] (cnn) {CNN};
\node[perc,right of=cnn, xshift=2em] (median) {Median Filter};
\node[node distance=1cm,above= of cnn.west,anchor=west] (perception) {Perception};

\begin{pgfonlayer}{background}
    \node[fit=(perception) (cnn) (median), draw,fill=yellow!20] (frame) {}; 
\end{pgfonlayer}

%% Control Nodes
\node[control,node distance=6cm, minimum width=2cm,below of=cnn] (state)
    {State Machine};
\node[control,right of=state,minimum width=0.5cm,minimum
    height=1cm,yshift=1cm,xshift=-.5cm,text width=1cm]
    (pid) {PID};
\node[control,right of=pid,minimum width=2cm,minimum height=1cm, xshift=2cm]
    (safety) {Safety Mechanism};
\node[control, node distance=2cm,below of=pid,minimum width=2cm,minimum
    height=1cm,yshift=-1.5em,xshift=1.5em] (low) {Low Level Control};
\node[node distance=2cm,above= of state.west,anchor=west] (controller)
    {Control};

\begin{pgfonlayer}{background}
    \node[fit=(state) (pid) (safety) (low) (controller), draw,fill=yellow!20]
        (frame) {}; 
\end{pgfonlayer}

%% Connections
\draw[thick] (cam) -- node[yshift=1em]{\emph{image}} (cnn);
\draw[thick] (cnn) -- node[yshift=1em]{\emph{prediction}} (median);
\draw[thick] (lidar.east) -- node[yshift=-3em,
    xshift=-0.5em]{\emph{height}} ++(1cm,0) |- (state);
\draw[thick] ($(vicon.south east)!0.33!(vicon.north east)$) -| node[yshift=-5.5em,
    xshift=-1.5em]{\emph{pose}} ($(pid.north west)!0.33!(pid.north east)$);
\draw[thick] ($(vicon.north east)!0.33!(vicon.south east)$) -| node[yshift=-6.5em,
    xshift=1.5em]{\emph{pose}}(safety.north);
%\draw[thick] (pid.west) -- ($(state.north east)!0.17!(state.south east)$);
\draw[thick] (state.east) -|
    node[xshift=-9em, yshift=-1em]{\emph{velocity command}}
    ($(safety.south west)!0.33!(safety.south east)$);
\draw[thick] (pid) -- node[text width=2cm,yshift=.5cm]{\emph{velocity command}} (safety);
\draw[thick] ($(safety.south west)!0.66!(safety.south east)$) |-
    node[xshift=-3em,yshift=-1em]{\emph{velocity command}}
    (low.east);
\draw[thick] ($(median.south east)!0.33!(median.south west)$) --
    node[xshift=-2em, yshift=-3.5em]{\emph{filtered prediction}} ++(0,-2cm)
    -|($(pid.north west)!0.68!(pid.north east)$);
\draw[thick] ($(median.south west)!0.33!(median.south east)$) -- ++(0,-.5cm) -|
    node[xshift=-2em, yshift=-4.5em, text width=2cm]{\emph{filtered prediction}}
    ($(state.north west)!0.68!(state.north east)$);
\end{tikzpicture}
